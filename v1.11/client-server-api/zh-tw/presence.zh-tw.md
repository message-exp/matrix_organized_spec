# 在線狀態

[![en](https://img.shields.io/badge/lang-en-purple.svg)](https://github.com/message-exp/matrix_organized_spec/tree/main/v1.11/client-server-api/en/presence.md)

每個使用者都有在線狀態資訊的概念。這包括：

- 使用者當前是否在線
- 使用者最近一次活動的時間（由伺服器觀察到）
- 給定用戶端是否認為使用者當前處於閒置狀態
- 有關使用者當前狀態的任意資訊（例如"正在開會"）

這些資訊從每個設備（`online`、`idle`、`last_active`）和每個使用者（狀態）的資料中收集，由使用者的家伺服器匯總，並作為 `m.presence` 事件傳輸。在使用者共享房間成員資格的情況下，在線狀態事件會發送給感興趣的各方。

使用者的在線狀態由 `presence` 鍵表示，它是以下之一的枚舉：

- `online`：使用者連接到事件流時的默認狀態。
- `unavailable`：使用者此時無法聯繫，例如他們處於閒置狀態。
- `offline`：使用者未連接到事件流或明確抑制他們的個人資料資訊被發送。

#### 事件

{{% event-group group_name="m.presence" %}}

#### 用戶端行為

用戶端可以使用下面列出的 HTTP API 手動設置/獲取他們的在線狀態。

{{% http-api spec="client-server" api="presence" %}}

##### 最後活動時間

伺服器維護一個時間戳，記錄最後一次看到使用者主動事件的時間。主動事件可能是向房間發送消息或將在線狀態更改為 `online`。這個時間戳通過一個名為 `last_active_ago` 的鍵呈現，給出自主動事件以來的相對毫秒數。

為了減少發送給用戶端的在線狀態更新數量，當在線狀態為 `online` 時，伺服器可能包含一個 `currently_active` 布爾字段。當為真時，伺服器將不會進一步更新最後活動時間，直到向用戶端發送更新，其中 a) `currently_active` 設置為假或 b) 在線狀態不是 `online`。在此期間，用戶端必須認為使用者當前處於活動狀態，而不考慮最後活動時間。

無論何時伺服器向用戶端提供在線狀態事件時，最後活動時間都必須是最新的。`currently_active` 機制應該純粹被伺服器用來停止發送連續的在線狀態更新，而不是完全禁用最後活動追蹤。因此，用戶端可以通過明確請求特定使用者的在線狀態來獲取最新的最後活動時間。

##### 閒置超時

如果使用者的最後活動時間超過閾值（例如 5 分鐘），伺服器將自動將使用者的在線狀態設置為 `unavailable`。用戶端可以手動將使用者的在線狀態設置為 `unavailable`。任何在使用者的任何用戶端上提升最後活動時間的活動都將導致伺服器自動將其在線狀態設置為 `online`。

#### 安全考慮

在線狀態資訊與目標使用者共享房間的所有使用者共享。在大型公共房間中，這可能是不受歡迎的。
